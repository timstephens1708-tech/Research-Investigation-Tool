# Session Notes — 2026-02-04

## Summary
This session focused on aligning Supabase (Postgres) schema with backend behavior, enforcing evidence integrity at the database level, preventing silent data loss from cascading deletes, and improving PDF export traceability by linking SearchRounds ↔ Sources.

## Key decisions
- Supabase PostgreSQL is the single source of truth.
- Evidence model is lean: evidence does not store project_id; project traceability is derived via evidence.source_id → sources.project_id.
- Evidence-to-quote linkage must be enforced by DB constraints (no trigger-based enforcement).
- Prevent silent cascade deletes; archive is the default user-facing delete for projects/sources.
- Export is organized primarily by SearchRound (per phase), with multi-linked sources shown under each linked round.

## Changes implemented

### 1) Evidence integrity (AC-1.1)
- Enforced "extract belongs to source" using a composite foreign key:
  - quotes has UNIQUE (id, source_id)
  - evidence has FK (extract_id, source_id) → quotes(id, source_id)
- evidence insert errors surface as HTTP 400 on FK violation.

Files:
- server/index.js
- server/supabase_schema.sql
- server/supabase_migration_evidence_integrity.sql
- server/supabase_audit_evidence_integrity.sql

How to apply (Supabase):
- Run: server/supabase_migration_evidence_integrity.sql
- Validate with: server/supabase_audit_evidence_integrity.sql

### 2) Sources.summary required
- Backend now requires non-empty summary on create source (HTTP 400 if missing).
- DB constraint added to block empty/whitespace summary (added as NOT VALID for safe rollout).

Files:
- server/index.js
- server/supabase_schema.sql
- server/supabase_migration_sources_summary_required.sql
- server/supabase_audit_sources_summary.sql

How to apply (Supabase):
- Run: server/supabase_migration_sources_summary_required.sql
- Audit: server/supabase_audit_sources_summary.sql
- Optional hardening step after cleanup:
  - ALTER TABLE public.sources VALIDATE CONSTRAINT sources_summary_nonempty;

### 3) Deletion safety & audit integrity
- Produced an FK audit query for ON DELETE behavior.
- Migration script drops & recreates key FKs to use RESTRICT/NO ACTION where required.
- Only the join table round_sources may cascade delete links.
- Backend delete endpoints return HTTP 409 when blocked by FK constraints, advising to archive instead.

Files:
- server/supabase_audit_fk_on_delete.sql
- server/supabase_migration_deletion_safety.sql
- server/supabase_schema.sql
- server/index.js

How to apply (Supabase):
- Run audit: server/supabase_audit_fk_on_delete.sql
- Apply migration: server/supabase_migration_deletion_safety.sql
- Re-run audit to confirm critical tables no longer use CASCADE.

### 4) Export fix — link SearchRounds ↔ Sources in PDF
- Export is now round-centric (per SearchRound).
- Uses a two-phase fetch strategy:
  - Phase 1: project + rounds + queries
  - Phase 2: round_sources mapping + sources + quotes + evidence
- Multi-linked sources appear under every linked round with a badge listing linked rounds.
- Unassigned sources (no round_sources row) are rendered in a warning section.
- Export response Content-Type set to application/pdf.

Files:
- server/index.js

## Local testing
- Backend: http://localhost:5000
- Frontend: Vite dev server (port may vary, e.g. 5174 if 5173 is in use)

Suggested checks:
- Evidence integrity:
  - Create evidence for a valid source → should succeed.
  - Attempt evidence with extract_id from another source → should return 400.
- Deletion safety:
  - Attempt deleting a round/quote that has dependent data → should return 409.
- Export:
  - Export project PDF and verify sources appear under correct rounds.
  - Verify unassigned sources section appears if applicable.

## Notes
- server/schema.sql is legacy and not authoritative for Supabase.
